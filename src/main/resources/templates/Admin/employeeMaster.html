<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Master</title>
    <style>
        /* Base Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f4f4f4;
        }

        .header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #003366;
            color: white;
            padding: 24px 20px;
            position: fixed;
            top: 0;
            width: 99%;
            z-index: 100;
        }

        .header-left img {
            height: 50px;
            padding-left: 62%;
        }

        .header-center {
            flex: 1;
            padding-left: 57px;
            text-align: center;
        }

        .header-center h1 {
            margin: 0;
            font-size: 24px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 20px;
        }

        .profile-img {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background-color: #0055aa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .profile-details {
            text-align: right;
        }

        .profile-name {
            margin: 0;
            font-size: 14px;
            font-weight: bold;
        }

        .admin-id {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Session expiry modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 5px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .primary-button {
            background-color: #003366;
            color: white;
        }

        .secondary-button {
            background-color: #6c757d;
            color: white;
        }
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 100px;
            width: 213px;
            height: calc(100% - 100px);
            background-color: #333;
            color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 90;
        }

        .sidebar.hidden {
            transform: translateX(-250px);
            width: 0;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar ul li {
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .sidebar ul li a {
            text-decoration: none;
            color: white;
            display: block;
        }

        .sidebar ul li a:hover, .sidebar ul li.active a {
            background-color: #555;
        }

        /* Main Content Styles */
        .main-content {
            margin-right: 1%;
            margin-left: 223px;
            padding: 20px;
            transition: margin-left 0.3s ease;
            margin-top: 5.5%;
        }
        .main-content.collapsed {
            margin-left: 0;
            padding-top: 3%;
            padding-left: 8%;
            padding-right: 8%;
            margin-bottom: 10%;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        .tab {
            padding: 15px 30px;
            background-color: #e0e0e0;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex: 1;
        }

        .tab.active {
            background-color: #003366;
            color: white;
        }

        /* Content Styles */
        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Form Container */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Form Header */
        .form-header {
            background-color: #fff3e6;
            padding: 15px;
            border-bottom: 1px dashed #ccc;
        }

        .form-header h1 {
            margin: 0;
            text-align: center;
            font-size: 24px;
            color: #333;
        }

        /* Button Container */
        .button-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px dashed #ccc;
            background-color: #fff3e6;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #003366;
            color: white;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #002244;
        }

        /* Form Content */
        .form-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[disabled] {
            background-color: #f9f9f9;
            color: #666;
        }

        .required::after {
            content: " *";
            color: red;
        }

        /* Search Options */
        .search-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .search-option {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-option h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            color: #003366;
        }

        .search-form {
            display: flex;
            gap: 10px;
        }
        .search-form select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .search-form input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        th, td {
            border: 2px solid #ddd; /* Light border for a neat look */
            padding: 9px; /* Adds spacing for readability */
            text-align: left; /* Aligns text */
            font-size: 14px;
            white-space: nowrap;
        }

        th {
            background-color: #003366;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f2fff5; /* Hover effect */
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 110px;
            right: 20px;
            padding: 15px;
            border-radius: 4px;
            color: white;
            display: none;
            z-index: 1000;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        /* Toggle Button */
        .toggle-btn {
            background-color: #003366;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            position: absolute;
            top: 29px;
            left: 10px;
            z-index: 1000;
        }

        /* Footer Styles */
        footer {
            background-color: #003366;
            color: white;
            text-align: center;
            padding: 10px 20px;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 90;
        }
    </style>
</head>
<body>
    <header class="header-main">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
        <div class="header-left">
            <img src="https://www.dot1.in/img/dot1.png" alt="Logo">
        </div>
        
        <div class="header-center">
            <h1>TRACK</h1>
        </div>
        <div class="header-right" id="profileSection">
            <!-- Profile content will be dynamically inserted here -->
        </div>
    </header>

    <div class="sidebar">
        <ul>
            <li ><a href="adminDashboard">Dashboard</a></li>
            <li class="active"><a href="adminmaster">Masters</a></li>
            <li><a href="adminticketCr">Create Ticket</a></li>
            <li><a href="admintAlltickets">Tickets</a></li>
            <li><a href="admintReports">Reports</a></li>
            <li><a href="Logout" onclick="logout()">Log Out</a></li>
        </ul>
    </div>

    <main class="main-content">
        <h2>Employee Master</h2>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('view')">View Master</button>
            <button class="tab" onclick="showTab('add')">Add Master</button>
            <button class="tab" onclick="showTab('update')">Update Master</button>
        </div>

        <div id="view" class="tab-content active">
            <button class="btn" onclick="fetchAllEmployees()">View All Employees</button>
            <button class="btn" onclick="showTab('find')">Find by</button>
            
            <div class="table-container">
                <table id="viewEmployeeTable">
                    <thead>
                        <tr>
                            <th>Emp Code</th>
                            <th>Name</th>
                            <th>Email ID</th>
                            <th>Phone No.</th>
                            <th>Date of Join</th>
                            <th>Active</th>
                            <th>Role Name</th>
                            <th>Business Entity</th>
                            <th colspan="2">Module</th>
                        </tr>
                        <tr>
                            <th colspan="8"></th>
                            <th>ModCode</th>
                            <th>Is Active</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="find" class="tab-content">
            <div class="search-options">
                <div class="search-option">
                    <h3>Find by Employee Code</h3>
                    <div class="search-form">
                        <input type="text" id="searchEmpCode" placeholder="Enter Employee Code">
                        <button class="btn" onclick="findByEmpCode()">Find</button>
                    </div>
                </div>
                <div class="search-option">
                    <h3>All Users According to All Role</h3>
                    <div class="search-form">
                        <select id="allRolesSelect" required>
                            <option value="">Select Role</option>
                        </select>
                        <button class="btn" onclick="findUsersByRole()">Find</button>
                    </div>
                </div>
              
            </div>
            
            <h3 id="selectedRoleHeader" class="role-name-header"></h3>
            <div class="table-container">
                <table id="findUsersTable">
                    <thead>
                        <tr>
                            <th>Emp Code</th>
                            <th>Name</th>
                            <th>Email ID</th>
                            <th>Phone No.</th>
                            <th>Date of Join</th>
                            <th>Is Active</th>
                            <th>Role Name</th>
                            <th>Business Entity</th>
                            <th colspan="2">Module</th>
                        </tr>
                        <tr>
                            <th colspan="8"></th>
                            <th>ModCode</th>
                            <th>Is Active</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>

        <div id="add" class="tab-content">
            <div class="form-container">
                <div class="form-header">
                    <h1>New Employee</h1>
                </div>
                
                <div class="button-container">
                    <button class="btn" onclick="goBack()">&lt;&lt; Return</button>
                    <button class="btn" onclick="saveAndNext()">Save & Next</button>
                    <button class="btn" onclick="saveAndReturn()">Save & Return</button>
                    <button class="btn" onclick="resetForm()">Reset</button>
                </div>

                <div class="form-content">
                    <form id="addEmployeeForm" onsubmit="handleSubmit(event)">
                        <div class="form-group">
                            <label for="empCode" class="required">Employee Code</label>
                            <small  class="required" style="color: rgb(235, 18, 18); display: block; margin-top: 5px;">Please type a unique employee code.</small>
                            <input type="text" id="empCode" required oninput="formatTextempCode()">
                        </div>

                        <div class="form-group">
                            <label for="empName" class="required">Name</label>
                            <input type="text" id="empName" placeholder="Employee Name" required oninput="formatTextempName()">
                        </div>
                     

                        <div class="form-group">
                            <label for="emailId" class="required">Email ID</label>
                            <input  type="email" id="emailId" placeholder="Employee Email ID (Eg: Diya.Bhs@dot1.in)" required oninput="formatTextemailId()">
                        </div>
                        <div>
                            <p id="emailMessage" class="error" style="color: rgb(235, 18, 18); display: block; margin-top: 5px;" ></p>
                        </div>
                        <div class="form-group">
                            <label for="phoneNo" class="required">Phone No.</label>
                            <small  class="required" style="color: rgb(235, 18, 18); display: block; margin-top: 5px;">Please type a Unique Phone No.</small>
                            <input type="number" id="phoneNo" pattern="[0-9]{10}" maxlength="10" required oninput="formatTextphoneNo()" onkeydown="return (event.keyCode !== 69 && event.keyCode !== 190 && event.keyCode !== 189 && event.keyCode !== 187)">
                        </div>
                        <div>
                            <p id="phoneMessage" class="error"  style="color: rgb(235, 18, 18); display: block;"></p>
                            </div>

                        <div class="form-group">
                            <label for="dateOfJoining" class="required">Date of Join</label>
                            <input type="date" id="dateOfJoining" required max="" min="">
                        </div>

                        <div class="form-group">
                            <label for="role" class="required">Role</label>
                            <select id="role" required onchange="handleRoleChange()">
                                <option value="">Select Role (Eg: Consultant, Admin)</option>
                            </select>
                        </div>

                        <div id="companyModuleSection" style="display: none;">
                            <div class="form-group">
                                <label for="company" class="required">Business Entity</label>
                                <select id="company" required onchange="handleCompanyChange()">
                                    <option value="">Select Business Entity</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="module" class="required">Module</label>
                                <select id="module" required>
                                    <option value="">Select Module</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="isActive" checked>
                                Is Active
                            </label>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="update" class="tab-content">
            <div class="search-options">
                <!-- <div class="search-option">
                    <h3>Find by Employee Code</h3>
                    <div class="search-form">
                        <input type="text" id="updateSearchEmpCode" placeholder="Enter Employee Code">
                        <button class="btn" onclick="findForUpdate('code')">Find</button>
                    </div>
                </div>
                <div class="search-option">
                    <h3>Find by Employee Name</h3>
                    <div class="search-form">
                        <input type="text" id="updateSearchEmpName" placeholder="Enter Employee Name">
                        <button class="btn" onclick="findForUpdate('name')">Find</button>
                    </div>
                </div>
            </div>
            <div id="updateFormContainer" class="form-container" style="display: none;">
            </div> -->

            <h4>This function is currently in Devlopment phase</h4>
        </div>
    </main>
    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <h3>Session Expired</h3>
            <p>Your session has expired. Please login again to continue.</p>
            <div class="modal-buttons">
                <button class="modal-button primary-button" onclick="redirectToLogin()">Login</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <footer>
        &copy; 2025 DOT 1. All Rights Reserved.
    </footer>

    <script>
    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();
        loadUserProfile();
        fetchAllEmployees();
        
        // Check token expiration immediately
        checkTokenExpiration();
        
        // Set up token expiration check every 30 seconds
        setInterval(checkTokenExpiration, 30000);

        // Set date restrictions for dateOfJoining
        const dateInput = document.getElementById('dateOfJoining');
        const today = new Date();
        const tenYearsAgo = new Date();
        tenYearsAgo.setFullYear(today.getFullYear() - 10);
            
        // Format dates as YYYY-MM-DD for input[type="date"]
        const formatDateForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
            
        dateInput.max = formatDateForInput(today);
        dateInput.min = formatDateForInput(tenYearsAgo);
    });
    
  // Function to check if token is expired
  function isTokenExpired() {
    const tokenExpiry = localStorage.getItem('tokenExpiry');
    
    if (!tokenExpiry) {
        return true; // If there's no expiry time stored, assume expired
    }

    const expiryTime = Number(tokenExpiry); // Convert to number safely
    
    if (isNaN(expiryTime)) {
        console.warn("Invalid token expiry value in localStorage.");
        return true; // Treat invalid values as expired
    }

    console.log("Stored Token Expiry:", expiryTime, "Current Time:", Date.now());

    return Date.now() > expiryTime;
}

   
    // Function to check token expiration
    function checkTokenExpiration() {
        if (isTokenExpired()) {
            showSessionExpiredModal();
        }
    }
    
     // Function to show session expired modal
     function showSessionExpiredModal() {
        const modal = document.getElementById('sessionModal');
        modal.style.display = 'block';
        
        // Prevent closing the modal by clicking outside
        window.onclick = function(event) {
            if (event.target === modal) {
                // Do nothing - force user to click the login button
            }
        };
    }
    
    // Function to redirect to login page
    function redirectToLogin() {
        logout();
        window.location.href = 'Logout';
    }
    
    // Function to check authentication
    function checkAuthentication() {
        const token = localStorage.getItem('authToken');
        if (!token || isTokenExpired()) {
            redirectToLogin();
        }
    }
    
    // Function to load user profile
    function loadUserProfile() {
        try {
            const employeeDataStr = localStorage.getItem('employeeData');
            if (!employeeDataStr) {
                return;
            }
            
            const employeeData = JSON.parse(employeeDataStr);
            const profileSection = document.getElementById('profileSection');
            
            // Get first letter of employee name for avatar
            const firstLetter = employeeData.empName ? employeeData.empName.charAt(0).toUpperCase() : 'U';
            
            profileSection.innerHTML = `
                <div class="profile-img">${firstLetter}</div>
                <div class="profile-details">
                    <p class="profile-name">${employeeData.empName || 'User'}</p>
                    <p class="admin-id">Admin ID: ${employeeData.empCode || 'N/A'}</p>
                </div>
            `;
        } catch (error) {
            console.error('Error loading user profile:', error);
        }
    }
    

    
    // Function to handle logout
    function logout() {
        // Clear all authentication data
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('tokenExpiry');
        localStorage.removeItem('userID');
        localStorage.removeItem('employeeData');
        
        // Redirect to login page
        window.location.href = 'Logout';
    }
     // Function to save authentication token with expiry
     function saveAuthToken(token, expiresIn) {
        const expiryTime = expiresIn * 10000000;
        localStorage.setItem('authToken', token);
        localStorage.setItem('tokenExpiry', expiryTime);
        console.log("Token Expiry Set:", expiryTime);
    }
    // Helper function to make authenticated API requests
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('authToken');
        if (!token) {
            throw new Error('No authentication token found');
        }
        
        // Set default options
        const defaultOptions = {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        };
        
        // Merge options
        const mergedOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...(options.headers || {})
            }
        };
        
        try {
            const response = await fetch(url, mergedOptions);
            
            if (response.status === 401 || response.status === 403) {
                // Token might be expired or invalid
                checkTokenExpiration();
                throw new Error('Authentication failed');
            }
            
            if (!response.ok) {
                throw new Error(`Request failed with status ${response.status}`);
            }
            
            return response;
        } catch (error) {
            console.error('API request error:', error);
            throw error;
        }
    }
    async function findUsersByRole() {
        const roleName = document.getElementById('allRolesSelect').value;
        if (!roleName) {
            showToast('Please select a role', 'error');
            return;
        }
    
        const token = localStorage.getItem('authToken'); // Assuming you store JWT tokens
        if (!token) {
            showToast('Authentication required', 'error');
            return;
        }
    
        try {
            const response = await fetch(`http://103.115.194.81:8080/ticket/Admin/Role/getByRole/${roleName}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                   
                },
            });
    
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    checkTokenExpiration();
                }
                throw new Error('Failed to fetch users');
            }
    
            const data = await response.json();
            document.getElementById('selectedRoleHeader').textContent = `Users with Role: ${roleName}`;
            document.getElementById('selectedRoleHeader').style.display = 'block';
    
            const tbody = document.querySelector('#findUsersTable tbody');
            tbody.innerHTML = '';
    
            if (Array.isArray(data.employeeMasterList) && data.employeeMasterList.length > 0) {
                data.employeeMasterList.forEach(employee => {
                    const formattedDate = employee.dateOfJoining ? employee.dateOfJoining.split('T')[0] : 'N/A';
                    const row = document.createElement('tr');
    
                    row.innerHTML = `
                        <td>${employee.empCode || 'N/A'}</td>
                        <td>${employee.empName || 'N/A'}</td>
                        <td>${employee.emailId || 'N/A'}</td>
                        <td>${employee.phoneNo || 'N/A'}</td>
                        <td>${formattedDate}</td>
                        <td>${employee.isActive ? 'Yes' : 'No'}</td>
                        <td>${data.roleName || 'N/A'}</td>
                        <td>${employee.companyName || 'N/A'}</td>
                        <td>${employee.modulesMaster_id?.modcode || 'N/A'}</td>
                        <td>${employee.modulesMaster_id?.isactive ? 'Yes' : 'No'}</td>
                    `;
                    tbody.appendChild(row);
                });
    
                showToast(`Found ${data.employeeMasterList.length} users`, 'success');
            } else {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No users found</td></tr>';
                showToast('No users found for this role', 'warning');
            }
        } catch (error) {
            console.error('Error fetching users:', error);
            showToast('Failed to fetch users', 'error');
        }
    }
    
    async function populateRoleDropdowns() {
        try {
            const token = localStorage.getItem('authToken'); // Assuming JWT authentication
            if (!token) {
                showToast('Authentication required', 'error');
                return;
            }
    
            // Fetch all roles
            const response = await fetch('http://103.115.194.81:8080/ticket/Admin/Role/getAll', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            });
    
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    checkTokenExpiration(); // Handle expired session
                }
                throw new Error('Failed to fetch roles');
            }
    
            const allRoles = await response.json();
            const allRolesSelect = document.getElementById('allRolesSelect');
    
            // Clear and populate roles dropdown
            allRolesSelect.innerHTML = '<option value="">Select Role</option>';
            allRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.roleName;
                option.textContent = role.roleName;
                allRolesSelect.appendChild(option);
            });
    
            showToast('Roles loaded successfully', 'success');
        } catch (error) {
            console.error('Error fetching roles:', error);
            showToast('Failed to fetch roles', 'error');
        }
    }
    



  

        function formatTextphoneNo() {
            let phone = document.getElementById("phoneNo").value;
            let phoneMessage = document.getElementById("phoneMessage");

            // Limit to 10 digits
            if (phone.length > 10) {
                document.getElementById("phoneNo").value = phone.slice(0, 10);
                phone = phone.slice(0, 10);
            }

            let phoneRegex = /^[0-9]{10}$/;

            if (!phoneRegex.test(phone)) {
                phoneMessage.textContent = "Invalid phone number! It must be exactly 10 digits.";
                phoneMessage.className = "error";
                return;
            }

            phoneMessage.textContent = "Valid Phone Number!";
            phoneMessage.className = "success";
        }

        document.getElementById("phoneNo").addEventListener("input", function () {
            formatTextphoneNo();
        })

        function formatTextemailId() {
            let email = document.getElementById("emailId").value;
            let emailMessage = document.getElementById("emailMessage");

            // Allowed characters: a-z, 0-9, _, @, .
            let emailRegex = /^[a-z0-9_@.]+$/;
            let validDomains = ["dot1.in"];

            if (!email.includes("@")) {
                emailMessage.textContent = "Invalid email! '@' is missing.";
                emailMessage.className = "error";
                return;
            }

            if (!emailRegex.test(email)) {
                emailMessage.textContent = "Invalid email! Only lowercase letters, numbers, '_', '@', and '.' are allowed.";
                emailMessage.className = "error";
                return;
            }

            let domain = email.split("@")[1];

            if (!validDomains.includes(domain) && !domain.endsWith("dot1.in")) {
                emailMessage.textContent = "Invalid email! Allowed domains: dot1.in";
                emailMessage.className = "error";
                return;
            }

            emailMessage.textContent = "Valid Email!";
            emailMessage.className = "success";
        }


        document.getElementById("emailId").addEventListener("input", function () {
            formatTextemailId();
        })



        function formatTextempName() {
            let inputField = document.getElementById("empName");
            let text = inputField.value;

            // Remove invalid characters (allow only a-z, A-Z, 0-9, -, _ and spaces)
            text = text.replace(/[^a-zA-Z ]/g, "");

            let words = text.split(/(\s|-|_)/); // Keep spaces, dashes, and underscores

            let formattedText = words.map(word => {
                if (/\w/.test(word)) { // Ensure it contains at least one letter/number
                    let firstChar = word.charAt(0).toUpperCase();
                    let rest = word.slice(1);
                    return firstChar + rest;
                }
                return word; // Preserve spaces, dashes, and underscores
            }).join("");

            inputField.value = formattedText;
        }
 
         document.getElementById("empName").addEventListener("input", function () {
             formatTextcmeName();
         })



        function formatTextempCode() {
           let inputField = document.getElementById("empCode");
           let text = inputField.value;

           // Remove invalid characters (allow only a-z, A-Z, 0-9, -, _ and spaces)
           text = text.replace(/[^a-zA-Z0-9\-_]/g, "");

           let words = text.split(/(\s|-|_)/); // Keep spaces, dashes, and underscores

           let formattedText = words.map(word => {
               if (/\w/.test(word)) { // Ensure it contains at least one letter/number
                   let firstChar = word.charAt(0).toUpperCase();
                   let rest = word.slice(1);
                   return firstChar + rest;
               }
               return word; // Preserve spaces, dashes, and underscores
           }).join("");

           inputField.value = formattedText;
       }

        document.getElementById("empCode").addEventListener("input", function () {
            formatTextcmeName();
        })
         

        
        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('.main-content');
            sidebar.classList.toggle('hidden');
            main.classList.toggle('collapsed');
        }

        // Show Toast Notification
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Tab Navigation
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Helper function to format date
        function formatDate(dateString) {
            return new Date(dateString).toISOString().split('T')[0];
        }


         // Fetch All Employees
         async function fetchAllEmployees() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                const response = await fetch('http://103.115.194.81:8080/ticket/Admin/Employee/getAll', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 200) {
                const employees = await response.json();
                
                const tbody = document.querySelector('#viewEmployeeTable tbody');
                tbody.innerHTML = '';
                
                employees.forEach(employee => renderEmployee(employee, 'viewEmployeeTable'));
                
                showToast('Employees fetched successfully', 'success');
                }else {
                    // Handle authentication errors or other status codes
                    if (response.status === 401 || response.status === 403 || response.status === 500) {
                        // Token might be expired or invalid
                        checkTokenExpiration();
                        showSessionExpiredModal();
                    }
                    throw new Error(`Failed to fetch entries: ${response.status}`);
                }
            } catch (error) {
                showToast('Failed to fetch employees', 'error');
            }
        }
        

        // Render Employee
        function renderEmployee(employee, tableId) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const row = document.createElement('tr');
            
            function formatDate(dateString) {
                if (!dateString) return '';
            
                // Remove the "T" and any time information to ensure correct parsing
                let dateParts = dateString.split('T')[0]; // Extract YYYY-MM-DD part
                let [year, month, day] = dateParts.split('-'); // Split into parts
            
                return `${day}-${month}-${year}`; // Format as DD-MM-YYYY
            }

            row.innerHTML = `
            <td>${employee.empCode || ''}</td>
            <td>${employee.empName || ''}</td>
            <td>${employee.emailId || ''}</td>
            <td>${employee.phoneNo || ''}</td>
            <td>${formatDate(employee.dateOfJoining)|| ''}</td>
            <td>${employee.isActive ? 'Yes' : 'No'}</td>
            <td>${employee.roleMaster_id?.roleName || ''}</td>
            <td>${employee.companyName || 'Null'}</td>
            <td>${employee.modulesMaster_id?.modcode || 'Null'}</td>
            <td>${employee.modulesMaster_id?.isactive ? 'Yes' : 'No'}</td>
        `;
            
            tbody.appendChild(row);
        }

        // Find by Employee Code
        async function findByEmpCode() {
           
            const empCode = document.getElementById('searchEmpCode').value;
            if (!empCode) {
                showToast('Please enter employee code', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                const response = await fetch(`http://103.115.194.81:8080/ticket/Admin/Employee/getByempCode/${empCode}`, { 
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
        if (response.status === 200) {
                
                const employee = await response.json();
                
                const tbody = document.querySelector('#findUsersTable tbody');
                tbody.innerHTML = '';
                
                if (employee) {
                    renderEmployee(employee, 'findUsersTable');
                    showToast('Employee found', 'success');
                } else {
                    showToast('Employee not found', 'error');
                }
            } else {
                // Handle authentication errors or other status codes
                if (response.status === 401 || response.status === 403 || response.status === 500) {
                    // Token might be expired or invalid
                    checkTokenExpiration();
                    showSessionExpiredModal();
                }
                throw new Error(`Failed to fetch entries: ${response.status}`);
            }
            } catch (error) {
                showToast('Failed to find employee', 'error');
            }
        }

        // Find by Employee Name
        async function findByEmpName() {
            const empName = document.getElementById('searchEmpName').value;
            if (!empName) {
                showToast('Please enter employee name', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                const response = await fetch(`http://103.115.194.81:8080/ticket/Admin/Employee/EmpName/${empName}`, { 
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 200) {


                const employee = await response.json();
                
                const tbody = document.querySelector('#findUsersTable tbody');
                tbody.innerHTML = '';
                
                if (employee) {
                    renderEmployee(employee, 'findUsersTable');
                    showToast('Employee found', 'success');
                } else {
                    showToast('Employee not found', 'error');
                }
            }else {
                // Handle authentication errors or other status codes
                if (response.status === 401 || response.status === 403 || response.status === 500) {
                    // Token might be expired or invalid
                    checkTokenExpiration();
                    showSessionExpiredModal();
                }
                throw new Error(`Failed to fetch entries: ${response.status}`);
            }
            } catch (error) {
                showToast('Failed to find employee', 'error');
            }
        }

        // Populate Role Dropdown
        async function populateRoleDropdown() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
        
                const response = await fetch('http://103.115.194.81:8080/ticket/Admin/Role/getAll', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
        
                if (response.status === 200) {  

                const roles = await response.json();
                
                const roleSelect = document.getElementById('role');
                roleSelect.innerHTML = '<option value="">Select Role (Eg: Consultant, Admin)</option>';
                
                roles.forEach(role => {
                    roleSelect.innerHTML += `<option value="${role.roleId}">${role.roleName}</option>`;
                });
            } else {
                // Handle authentication errors or other status codes
                if (response.status === 401 || response.status === 403 || response.status === 500) {
                    // Token might be expired or invalid
                    checkTokenExpiration();
                    showSessionExpiredModal();
                }
                throw new Error(`Failed to fetch entries: ${response.status}`);
            }
         }
          catch (error) {
                showToast('Failed to fetch roles', 'error');
            }
        }

        // Handle Role Change
        async function handleRoleChange() {
            const roleSelect = document.getElementById('role');
            const companyModuleSection = document.getElementById('companyModuleSection');
            const companySelect = document.getElementById('company');
            const moduleSelect = document.getElementById('module');
            const moduleGroup = moduleSelect.closest('.form-group');
            
            const selectedRole = roleSelect.options[roleSelect.selectedIndex].text;

            if (selectedRole === 'ADMIN') {
                companyModuleSection.style.display = 'none';
                companySelect.removeAttribute('required');
                moduleSelect.removeAttribute('required');
            } else if (selectedRole === 'MANAGER') {
                companyModuleSection.style.display = 'block';
                companySelect.setAttribute('required', 'true');
                moduleSelect.removeAttribute('required');
                // Hide module dropdown for MANAGER role
                if (moduleGroup) {
                    moduleGroup.style.display = 'none';
                }
                await populateCompanyDropdown();
            } else if (selectedRole === 'CONSULTANT') {
                companyModuleSection.style.display = 'block';
                companySelect.setAttribute('required', 'true');
                moduleSelect.setAttribute('required', 'true');
                // Show module dropdown for CONSULTANT role
                if (moduleGroup) {
                    moduleGroup.style.display = 'block';
                }
                await populateCompanyDropdown();
            } else {
                companyModuleSection.style.display = 'none';
                companySelect.removeAttribute('required');
                moduleSelect.removeAttribute('required');
            }
        }
        // Populate Company Dropdown
        async function populateCompanyDropdown() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                const response = await fetch('http://103.115.194.81:8080/ticket/Admin/Company/getAllActive', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
        
                if (response.status === 200) {


                const companies = await response.json();
                
                const companySelect = document.getElementById('company');
                companySelect.innerHTML = '<option value="">Select Company</option>';
                
                companies.forEach(company => {
                    companySelect.innerHTML += `<option value="${company.cmpid}">${company.cmpnm}</option>`;
                });
            }else {
                // Handle authentication errors or other status codes
                if (response.status === 401 || response.status === 403 || response.status === 500) {
                    // Token might be expired or invalid
                    checkTokenExpiration();
                    showSessionExpiredModal();
                }
                throw new Error(`Failed to fetch entries: ${response.status}`);
            }
            } catch (error) {
                showToast('Failed to fetch companies', 'error');
            }
        }

        async function handleCompanyChange() {
            const companyId = document.getElementById('company').value;
            if (!companyId) return;
        
            try {
                const token = localStorage.getItem('authToken'); // Fetch authentication token
                if (!token) {
                    showToast('Authentication required', 'error');
                    return;
                }
        
                const response = await fetch(`http://103.115.194.81:8080/ticket/Admin/ModulesMaster/GetAllModulesbyCmpID/${companyId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });
        
                if (response.status === 200) {
                    const modules = await response.json();
                    const moduleSelect = document.getElementById('module');
            
                    // Clear existing options and add a default option
                    moduleSelect.innerHTML = '<option value="">Select Module</option>';
                    
                    // Efficiently create and append options
                    modules.forEach(module => {
                        const option = document.createElement('option');
                        option.value = module.modId;
                        option.textContent = module.modcode;
                        moduleSelect.appendChild(option);
                    });
            
                    showToast('Modules fetched successfully', 'success');
               

                }else{
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration(); // Handle expired session
                    }
                    throw new Error('Failed to fetch modules');
                
                }

                   
        
                } catch (error) {
                console.error('Error fetching modules:', error);
                showToast('Failed to fetch modules', 'error');
            }
        }
        

        // Form Actions
        function goBack() {
            window.history.back();
        }

        async function saveAndNext() {
            if (await saveForm()) {
                resetForm();
            }
        }

        async function saveAndReturn() {
            if (await saveForm()) {
                goBack();
            }
        }

        function resetForm() {
            document.getElementById('addEmployeeForm').reset();
            document.getElementById('companyModuleSection').style.display = 'none';
        
            // Reset role dropdown to default
            document.getElementById('role').selectedIndex = 0;
            
            // Reset company dropdown
            document.getElementById('company').innerHTML = '<option value="">Select Company</option>';
        
            // Reset module dropdown
            document.getElementById('module').innerHTML = '<option value="">Select Module</option>';
        }
        // Save Form
        async function saveForm() {
            const form = document.getElementById('addEmployeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }

            const formData = {
                empCode: document.getElementById('empCode').value,
                empName: document.getElementById('empName').value,
                emailId: document.getElementById('emailId').value,
                phoneNo: document.getElementById('phoneNo').value,
                dateOfJoining: document.getElementById('dateOfJoining').value + " T 00:00:00",
                isActive: document.getElementById('isActive').checked,
                roleMaster_id: {
                    roleId: parseInt(document.getElementById('role').value)
                },
                modulesMaster_id: document.getElementById('module')?.value ? {
                    modId: parseInt(document.getElementById('module').value)
                } : null,
                companyName: document.getElementById('company')?.value ? 
                    document.querySelector('#company option:checked').text : null
            };

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                const response = await fetch('http://103.115.194.81:8080/ticket/Admin/Employee/addEmployee', {
                    method: 'Post',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });
                if (response.status === 200) {

                if (response.ok) {
                    showToast('Employee added successfully', 'success');
                    resetForm();
                    return true;

                } else {
                    showToast('Failed to add employee', 'error');
                    return false;
                }
            }else {
                // Handle authentication errors or other status codes
                if (response.status === 401 || response.status === 403 || response.status === 500) {
                    // Token might be expired or invalid
                    checkTokenExpiration();
                    showSessionExpiredModal();
                }
                throw new Error(`Failed to fetch entries: ${response.status}`);
            }
            } catch (error) {
                showToast('Failed to add employee', 'error');
                return false;
            }
        }

        // Handle form submission
        function handleSubmit(event) {
            event.preventDefault();
            saveForm();
        }

        // Initial load
        fetchAllEmployees();
        populateRoleDropdown();
        populateRoleDropdowns();

    </script>
</body>
</html>


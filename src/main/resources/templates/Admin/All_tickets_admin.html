<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Tickets</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f4f4f4;
        }

        /* Header Styles */
        .header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #003366;
            color: white;
            padding: 24px 20px;
            position: fixed;
            top: 0;
            width: 99%;
            z-index: 100;
        }

        .header-left img {
            height: 50px;
            padding-left: 62%;
        }

        .header-center {
            flex: 1;
            padding-left: 57px;
            text-align: center;
        }

        .header-center h1 {
            margin: 0;
            font-size: 24px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 20px;
        }

        .profile-img {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background-color: #0055aa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .profile-details {
            text-align: right;
        }

        .profile-name {
            margin: 0;
            font-size: 14px;
            font-weight: bold;
        }

        .admin-id {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 100px;
            width: 213px;
            height: calc(100% - 100px);
            background-color: #333;
            color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 90;
        }

        .sidebar.hidden {
            transform: translateX(-250px);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar ul li {
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .sidebar ul li a {
            text-decoration: none;
            color: white;
            display: block;
        }

        .sidebar ul li a:hover,
        .sidebar ul li.active a {
            background-color: #555;
        }

        /* Main Content */
        main {
            margin-left: 223px;
            padding: 20px;
            transition: margin-left 0.3s ease;
            margin-top: 90px;
            margin-bottom: 60px;
        }

        main.collapsed {
            margin-left: 0;
        }

        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background-color: #003366;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .filter-btn:hover {
            background-color: #004a8f;
        }

        .filter-btn.active {
            background-color: #004a8f;
            font-weight: bold;
        }

        /* Search Inputs */
        .search-container {
            display: none;
            margin-bottom: 20px;
            align-items: center;
            gap: 10px;
        }

        .search-container input,
        .search-container select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .search-container button {
            background-color: #003366;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Advanced Filter Container */
        .advanced-filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        /* Ticket Table Styles */
        .ticket-table-container {
            overflow-x: auto;
        }

        .ticket-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .ticket-table th,
        .ticket-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .ticket-table th {
            background-color: #003366;
            color: white;
            position: sticky;
            top: 0;
        }

        .ticket-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .ticket-table tr:hover {
            background-color: #f2fff5;
        }

        /* Level and Priority Badges */
        .level-badge,
        .priority-badge,
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            color: rgb(0, 0, 0);
            font-size: 15px;
            display: inline-block;
            text-align: center;
            min-width: 60px;
        }

        /* Level Colors */
        .level-L1 {
            background-color: #a7f0b6;
            /* Teal - Low */
            color: rgb(0, 0, 0);
            font-size: 15px;
        }

        .level-L2 {
            background-color: #eddf8a;
            /* Yellow */
        }

        .level-L3 {
            background-color: #efba8f;
            /* Orange */
        }

        .level-L4 {
            background-color: #dc3545;
            /* Red */
        }

        /* Priority Colors */
        .priority-P1 {
            background-color: #8b0000;
            /* Dark Red - Urgent */
            color: rgb(176, 174, 174);
        }

        .priority-P2 {
            background-color: #fd2414;
            /* Fiery Red - High */
        }

        .priority-P3 {
            background-color: #fd7e14;
            /* Warm Orange - Medium */
            color: black;
        }

        .priority-P4 {
            background-color: #2cee5397;
            /* Deep Cyan - Low */
        }

        /* Status Colors */
        .status-NEW {
            background-color: #007bff;
            /* Blue - New */
            color: white;
        }

        .status-IN-PROGRESS {
            background-color: #ffc107;
            /* Yellow - In Progress */
            color: black;
        }

        .status-RESOLVED {
            background-color: #28a745;
            /* Green - Resolved */
            color: white;
        }

        .status-CLOSED {
            background-color: #6c757d;
            /* Gray - Closed */
            color: white;
        }

        .status-PENDING {
            background-color: #dc3545;
            /* Red - Pending */
            color: white;
        }

        .view-btn {
            background-color: #003366;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .view-btn:hover {
            background-color: #004a8f;
        }

        /* Modal/Popup Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 80%;
            padding-top: 29px;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            color: #858585;
            float: right;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: -5px;
        }

        .close:hover {
            color: black;
        }

        /* Ticket Detail Styles */
        .ticket-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-header h2 {
            margin: 0;
            color: #003366;
        }

        .ticket-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .ticket-section h3 {
            margin-top: 0;
            color: #003366;
            font-size: 18px;
        }

        .ticket-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .info-item {
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
        }

        /* Attachment Styles */
        .attachments-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .attachment-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        .attachment-name {
            margin-bottom: 10px;
            word-break: break-all;
        }

        .attachment-actions {
            display: flex;
            gap: 10px;
        }

        .attachment-btn {
            flex: 1;
            padding: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }

        .describtion {
            border: 1px solid #ccc;
            border-left: 5px solid #007bff;
            border-radius: 6px;
            background-color: #fefefe;
            color: #333;
            font-size: 16px;
            padding: 15px;
            line-height: 1.6;
            margin-top: 10px;
            white-space: pre-line;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }


        .download-btn {
            background-color: #28a745;
            color: white;
        }

        .view-file-btn {
            background-color: #007bff;
            color: white;
        }

        /* Session expiry modal */
        .modal1 {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal1-content1 {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal1-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal1-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .primary1-button {
            background-color: #003366;
            color: white;
        }

        .primary1-button:hover {
            background-color: #004a8f;
        }

        .secondary1-button {
            background-color: #6c757d;
            color: white;
        }

        /* Footer Styles */
        .footer-main {
            background-color: #003366;
            color: white;
            text-align: center;
            padding: 10px 20px;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 90;
        }

        .toggle-btn {
            background-color: #003366;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            position: absolute;
            top: 29px;
            left: 10px;
            z-index: 1000;
        }

        /* Loading Indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .loading:after {
            content: " ";
            display: block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 6px solid #003366;
            border-color: #003366 transparent #003366 transparent;
            animation: loading 1.2s linear infinite;
        }

        @keyframes loading {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* No Results Message */
        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header-main {
                padding: 15px 10px;
            }

            .header-left img {
                padding-left: 20%;
            }

            .header-center {
                padding-left: 20px;
            }

            main {
                margin-left: 0;
                padding: 10px;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 14%;
                width: 213px;
                height: 100%;
                background-color: #333;
                color: white;
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
                overflow-y: auto;
                transform: translateX(0);
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .ticket-info {
                grid-template-columns: 1fr;
            }
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            background-color: #e9f2ff;
            padding: 10px 15px;
            border: 1px solid #cce0ff;
            border-radius: 4px;
            color: #003366;
        }

        .toggle-icon {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .collapsible-body {
            display: none;
            padding: 15px 10px 0;
        }

        .collapsible.active .collapsible-body {
            display: block;
        }

        .collapsible.active .toggle-icon {
            transform: rotate(45deg); /* turn "+" into "x" */
        }

    </style>
</head>

<body>

    <header class="header-main">
        <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
        <div class="header-left">
            <img src="https://www.dot1.in/img/dot1.png" alt="Logo">
        </div>

        <div class="header-center">
            <h1>TRACK</h1>
        </div>
        <div class="header-right" id="profileSection">
            <!-- Profile content will be dynamically inserted here -->
        </div>
    </header>

    <div class="sidebar">
        <ul>
            <li ><a href="adminDashboard">Dashboard</a></li>
            <li ><a href="adminmaster">Masters</a></li>
            <li class="active"><a href="adminticketCr">Create Ticket</a></li>
            <li ><a href="admintAlltickets">Tickets</a></li>
            <li><a href="admintReports">Reports</a></li>
            <li><a href="Logout" onclick="logout()">Log Out</a></li>
        </ul>
    </div>
    <main>
        <h2>View Tickets</h2>

        <div class="filter-buttons">
            <button class="filter-btn active" onclick="setActiveFilter(this, 'all')">View All</button>
            <button class="filter-btn" onclick="setActiveFilter(this, 'ticketCode')">Find by Ticket Code</button>
            <button class="filter-btn" onclick="setActiveFilter(this, 'company')">Find by Company</button>
            <button class="filter-btn" onclick="setActiveFilter(this, 'client')">Find by Client</button>
            <button class="filter-btn" onclick="setActiveFilter(this, 'module')">Find by Module</button>
        </div>

        <!-- Search by Ticket Code -->
        <div id="ticketCodeSearch" class="search-container">
            <input type="text" id="ticketCodeInput" placeholder="Enter Ticket Code">
            <button onclick="searchByTicketCode()">Search</button>
        </div>

        <!-- Search by Company -->
        <div id="companySearch" class="search-container">
            <select id="companySelect">
                <option value="">Select Company</option>
            </select>
            <button onclick="searchByCompany()">Search</button>
        </div>

        <!-- Search by Client -->
        <div id="clientSearch" class="search-container">
            <select id="clientSelect">
                <option value="">Select Client</option>
            </select>
            <button onclick="searchByClient()">Search</button>
        </div>

        <!-- Search by Module -->
        <div id="moduleSearch" class="search-container">
            <select id="moduleSelect">
                <option value="">Select Module</option>
            </select>
            <button onclick="searchByModule()">Search</button>
        </div>

        <!-- Advanced Filter Section -->
        <div class="advanced-filter-container">
            <div class="filter-group">
                <label for="statusFilter">Status</label>
                <select id="statusFilter">
                    <option value="">All Statuses</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="priorityFilter">Priority</label>
                <select id="priorityFilter">
                    <option value="">All Priorities</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="levelFilter">Level</label>
                <select id="levelFilter">
                    <option value="">All Levels</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="typeFilter">Type</label>
                <select id="typeFilter">
                    <option value="">All Types</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="filter-btn" onclick="applyAdvancedFilters()">Apply Filters</button>
                <button class="filter-btn" onclick="resetAdvancedFilters()">Reset</button>
            </div>
        </div>

        <div id="loadingIndicator" class="loading"></div>

        <div class="ticket-table-container">
            <table id="ticketTable" class="ticket-table">
                <thead>
                    <tr>
                        <th>Ticket Code</th>
                        <th>Ticket Level</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Business Entity</th>
                        <th>Client</th>
                        <th>Module</th>
                        <th>CME</th>
                        <th>Consultant</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="ticketTableBody">
                    <!-- Ticket data will be populated here -->
                </tbody>
            </table>
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            No tickets found matching your criteria.
        </div>
    </main>

    <!-- Ticket Detail Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="ticketDetails">
                <!-- Ticket details will be populated here -->
            </div>
        </div>
    </div>

    <div id="sessionModal" class="modal1">
        <div class="modal1-content1">
            <h3>Session Expired</h3>
            <p>Your session has expired. Please login again to continue.</p>
            <div class="modal1-buttons">
                <button class="modal-button primary-button" onclick="redirectToLogin()">Login</button>
            </div>
        </div>
    </div>
    <footer class="footer-main">
        &copy; 2025 DOT 1. All Rights Reserved.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            checkAuthentication();
            loadUserProfile();

            // Check token expiration immediately
            checkTokenExpiration();

            // Set up token expiration check every 30 seconds
            setInterval(checkTokenExpiration, 30000);
        });

        // Function to check if token is expired
        function isTokenExpired() {
            const tokenExpiry = localStorage.getItem('tokenExpiry');

            if (!tokenExpiry) {
                return true; // If there's no expiry time stored, assume expired
            }

            const expiryTime = Number(tokenExpiry); // Convert to number safely

            if (isNaN(expiryTime)) {
                console.warn("Invalid token expiry value in localStorage.");
                return true; // Treat invalid values as expired
            }

            console.log("Stored Token Expiry:", expiryTime, "Current Time:", Date.now());

            return Date.now() > expiryTime;
        }


        // Function to check token expiration
        function checkTokenExpiration() {
            if (isTokenExpired()) {
                showSessionExpiredModal();
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('main');
            sidebar.classList.toggle('hidden');
            main.classList.toggle('collapsed');
        }


        // Function to show session expired modal
        function showSessionExpiredModal() {
            const modal = document.getElementById('sessionModal');
            modal.style.display = 'block';

            // Prevent closing the modal by clicking outside
            window.onclick = function (event) {
                if (event.target === modal) {
                    // Do nothing - force user to click the login button
                }
            };
        }

        // Function to redirect to login page
        function redirectToLogin() {
            logout();
            window.location.href = 'Logout';
        }

        // Function to check authentication
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token || isTokenExpired()) {
                redirectToLogin();
            }
        }

        // Function to load user profile
        function loadUserProfile() {
            try {
                const employeeDataStr = localStorage.getItem('employeeData');
                if (!employeeDataStr) {
                    return;
                }

                const employeeData = JSON.parse(employeeDataStr);
                const profileSection = document.getElementById('profileSection');

                // Get first letter of employee name for avatar
                const firstLetter = employeeData.empName ? employeeData.empName.charAt(0).toUpperCase() : 'U';

                profileSection.innerHTML = `
                <div class="profile-img">${firstLetter}</div>
                <div class="profile-details">
                    <p class="profile-name">${employeeData.empName || 'User'}</p>
                    <p class="admin-id">Admin ID: ${employeeData.empCode || 'N/A'}</p>
              
                </div>
            `;
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }



        // Function to handle logout
        function logout() {
            // Clear all authentication data
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('tokenExpiry');
            localStorage.removeItem('userID');
            localStorage.removeItem('employeeData');

            // Redirect to login page
            window.location.href = 'Logout';
        }


        // Function to save authentication token with expiry
        function saveAuthToken(token, expiresIn) {
            const expiryTime = expiresIn * 10000000;
            localStorage.setItem('authToken', token);
            localStorage.setItem('tokenExpiry', expiryTime);
            console.log("Token Expiry Set:", expiryTime);
        }

        // Global variables
        let allTickets = [];
        let companies = new Set();
        let clients = new Set();
        let modules = new Set();
        let statuses = new Set();
        let priorities = new Set();
        let levels = new Set();
        let types = new Set();

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            fetchAllTickets();
        });

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('main');
            sidebar.classList.toggle('hidden');
            main.classList.toggle('collapsed');
        }

        // Set active filter button and show appropriate search container
        function setActiveFilter(button, filterType) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');

            // Hide all search containers
            document.querySelectorAll('.search-container').forEach(container => {
                container.style.display = 'none';
            });

            // Show appropriate search container based on filter type
            if (filterType !== 'all') {
                document.getElementById(`${filterType}Search`).style.display = 'flex';
            }

            // If "View All" is selected, fetch all tickets
            if (filterType === 'all') {
                fetchAllTickets();
            }
        }

        // Fetch all tickets
        async function fetchAllTickets() {
            showLoading(true);
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const response = await fetch('http://103.115.194.81:8080/ticket/Admin/ManagerTicket/getAllTkt', {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch tickets');
                }

                allTickets = await response.json();

                // Extract unique values for filters
                populateFilterDropdowns(allTickets);

                // Display tickets
                displayTickets(allTickets);
            } catch (error) {
                console.error('Error fetching tickets:', error);
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('noResults').textContent = 'Error loading tickets. Please try again later.';
            } finally {
                showLoading(false);
            }
        }

        // Populate filter dropdowns with unique values
        function populateFilterDropdowns(tickets) {
            // Clear existing sets
            companies = new Set();
            clients = new Set();
            modules = new Set();
            statuses = new Set();
            priorities = new Set();
            levels = new Set();
            types = new Set();

            // Extract unique values
            tickets.forEach(ticket => {
                if (ticket.companyname) {
                    companies.add(ticket.companyname);
                }

                if (ticket.clientid && ticket.clientid.clientName) {
                    clients.add(JSON.stringify({
                        id: ticket.clientid.clientId,
                        name: ticket.clientid.clientName
                    }));
                }

                if (ticket.modulesid && ticket.modulesid.modcode) {
                    modules.add(JSON.stringify({
                        id: ticket.modulesid.modId,
                        code: ticket.modulesid.modcode
                    }));
                }

                if (ticket.status && ticket.status.gmDescription) {
                    statuses.add(JSON.stringify({
                        id: ticket.status.gmid,
                        description: ticket.status.gmDescription
                    }));
                }

                if (ticket.priority && ticket.priority.gmDescription) {
                    priorities.add(JSON.stringify({
                        id: ticket.priority.gmid,
                        description: ticket.priority.gmDescription
                    }));
                }

                if (ticket.ticketlevel && ticket.ticketlevel.gmDescription) {
                    levels.add(JSON.stringify({
                        id: ticket.ticketlevel.gmid,
                        description: ticket.ticketlevel.gmDescription
                    }));
                }

                if (ticket.tickettype && ticket.tickettype.gmDescription) {
                    types.add(JSON.stringify({
                        id: ticket.tickettype.gmid,
                        description: ticket.tickettype.gmDescription
                    }));
                }
            });

            // Populate company dropdown
            const companySelect = document.getElementById('companySelect');
            companySelect.innerHTML = '<option value="">Select Company</option>';
            Array.from(companies).sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });

            // Populate client dropdown
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = '<option value="">Select Client</option>';
            Array.from(clients).map(client => JSON.parse(client))
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    clientSelect.appendChild(option);
                });

            // Populate module dropdown
            const moduleSelect = document.getElementById('moduleSelect');
            moduleSelect.innerHTML = '<option value="">Select Module</option>';
            Array.from(modules).map(module => JSON.parse(module))
                .sort((a, b) => a.code.localeCompare(b.code))
                .forEach(module => {
                    const option = document.createElement('option');
                    option.value = module.id;
                    option.textContent = module.code;
                    moduleSelect.appendChild(option);
                });

            // Populate advanced filter dropdowns

            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            statusFilter.innerHTML = '<option value="">All Statuses</option>';
            Array.from(statuses).map(status => JSON.parse(status))
                .sort((a, b) => a.description.localeCompare(b.description))
                .forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.description;
                    statusFilter.appendChild(option);
                });

            // Priority filter
            const priorityFilter = document.getElementById('priorityFilter');
            priorityFilter.innerHTML = '<option value="">All Priorities</option>';
            Array.from(priorities).map(priority => JSON.parse(priority))
                .sort((a, b) => a.description.localeCompare(b.description))
                .forEach(priority => {
                    const option = document.createElement('option');
                    option.value = priority.id;
                    option.textContent = priority.description;
                    priorityFilter.appendChild(option);
                });

            // Level filter
            const levelFilter = document.getElementById('levelFilter');
            levelFilter.innerHTML = '<option value="">All Levels</option>';
            Array.from(levels).map(level => JSON.parse(level))
                .sort((a, b) => a.description.localeCompare(b.description))
                .forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.id;
                    option.textContent = level.description;
                    levelFilter.appendChild(option);
                });

            // Type filter
            const typeFilter = document.getElementById('typeFilter');
            typeFilter.innerHTML = '<option value="">All Types</option>';
            Array.from(types).map(type => JSON.parse(type))
                .sort((a, b) => a.description.localeCompare(b.description))
                .forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.description;
                    typeFilter.appendChild(option);
                });
        }

        // Display tickets in the table
        function displayTickets(tickets) {
            const tableBody = document.getElementById('ticketTableBody');
            tableBody.innerHTML = '';

            if (tickets.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('ticketTable').style.display = 'none';
                return;
            }

            document.getElementById('noResults').style.display = 'none';
            document.getElementById('ticketTable').style.display = 'table';

            tickets.forEach(ticket => {
                const row = document.createElement('tr');

                // Ticket Code
                row.innerHTML = `
                <td>${ticket.ticketcode || 'N/A'}</td>
                <td>
                    ${ticket.ticketlevel && ticket.ticketlevel.gmDescription ?
                        `<span class="level-badge level-${ticket.ticketlevel.gmDescription}">${ticket.ticketlevel.gmDescription}</span>` :
                        'N/A'}
                </td>
                <td>
                    ${ticket.priority && ticket.priority.gmDescription ?
                        `<span class="priority-badge priority-${ticket.priority.gmDescription}">${ticket.priority.gmDescription}</span>` :
                        'N/A'}
                </td>
                <td>
                    ${ticket.status && ticket.status.gmDescription ?
                        `<span class="status-badge status-${ticket.status.gmDescription}">${ticket.status.gmDescription}</span>` :
                        'N/A'}
                </td>
                <td>${ticket.companyname || 'N/A'}</td>
                <td>${ticket.clientid && ticket.clientid.clientName ? ticket.clientid.clientName : 'N/A'}</td>
                <td>${ticket.modulesid && ticket.modulesid.modcode ? ticket.modulesid.modcode : 'N/A'}</td>
                <td>${ticket.cmexpertId && ticket.cmexpertId.cmeName ? ticket.cmexpertId.cmeName : 'N/A'}</td>
                <td>${ticket.employeeId ?
                        `${ticket.employeeId.empCode || ''} ${ticket.employeeId.empName || ''}`.trim() :
                        'Not Assign'}
                </td>
                <td>
                    <button class="view-btn" onclick="viewTicketDetails(${ticket.ticketid})">View</button>
                </td>
            `;

                tableBody.appendChild(row);
            });
        }

        // Apply advanced filters
        function applyAdvancedFilters() {
            const statusId = document.getElementById('statusFilter').value;
            const priorityId = document.getElementById('priorityFilter').value;
            const levelId = document.getElementById('levelFilter').value;
            const typeId = document.getElementById('typeFilter').value;

            let filteredTickets = [...allTickets];

            // Apply status filter
            if (statusId) {
                filteredTickets = filteredTickets.filter(ticket =>
                    ticket.status && ticket.status.gmid == statusId
                );
            }

            // Apply priority filter
            if (priorityId) {
                filteredTickets = filteredTickets.filter(ticket =>
                    ticket.priority && ticket.priority.gmid == priorityId
                );
            }

            // Apply level filter
            if (levelId) {
                filteredTickets = filteredTickets.filter(ticket =>
                    ticket.ticketlevel && ticket.ticketlevel.gmid == levelId
                );
            }

            // Apply type filter
            if (typeId) {
                filteredTickets = filteredTickets.filter(ticket =>
                    ticket.tickettype && ticket.tickettype.gmid == typeId
                );
            }

            displayTickets(filteredTickets);
        }

        // Reset advanced filters
        function resetAdvancedFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('levelFilter').value = '';
            document.getElementById('typeFilter').value = '';

            displayTickets(allTickets);
        }

        // Search by ticket code
        function searchByTicketCode() {
            const ticketCode = document.getElementById('ticketCodeInput').value.trim();
            if (!ticketCode) {
                alert('Please enter a ticket code');
                return;
            }

            const filteredTickets = allTickets.filter(ticket =>
                ticket.ticketcode && ticket.ticketcode.toLowerCase().includes(ticketCode.toLowerCase())
            );

            displayTickets(filteredTickets);
        }

        // Search by company
        function searchByCompany() {
            const company = document.getElementById('companySelect').value;
            if (!company) {
                alert('Please select a company');
                return;
            }

            const filteredTickets = allTickets.filter(ticket =>
                ticket.companyname === company
            );

            displayTickets(filteredTickets);
        }

        // Search by client
        function searchByClient() {
            const clientId = document.getElementById('clientSelect').value;
            if (!clientId) {
                alert('Please select a client');
                return;
            }

            const filteredTickets = allTickets.filter(ticket =>
                ticket.clientid && ticket.clientid.clientId == clientId
            );

            displayTickets(filteredTickets);
        }

        // Search by module
        function searchByModule() {
            const moduleId = document.getElementById('moduleSelect').value;
            if (!moduleId) {
                alert('Please select a module');
                return;
            }

            const filteredTickets = allTickets.filter(ticket =>
                ticket.modulesid && ticket.modulesid.modId == moduleId
            );

            displayTickets(filteredTickets);
        }

        // View ticket details
        async function viewTicketDetails(ticketId) {
            showLoading(true);
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const response = await fetch(`http://103.115.194.81:8080/ticket/Admin/ManagerTicket/getTicketWithAttachments/${ticketId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 200) {
                    if (!response.ok) {
                        throw new Error('Failed to fetch ticket details');
                    }

                    const ticket = await response.json();
                    displayTicketModal(ticket);
                } else {
                    // Handle authentication errors
                    if (response.status === 401 || response.status === 403 || response.status === 500) {
                        // Token might be expired or invalid
                        checkTokenExpiration();
                        showSessionExpiredModal();
                    }

                    throw new Error(`Failed to fetch ticket details: ${response.status}`);
                }
            } catch (error) {
                console.error('Error fetching ticket details:', error);
                alert('Failed to load ticket details. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Display ticket details in modal
        function displayTicketModal(ticket) {
            const modalContent = document.getElementById('ticketDetails');

            // Ticket header with ticket code and type
            let html = `
            <div class="ticket-header">
                <h2>${ticket.ticketcode || 'N/A'}</h2>
                <div>
                    ${ticket.tickettype && ticket.tickettype.gmDescription ?
                    `<strong>${ticket.tickettype.gmDescription}</strong>` : ''}
                </div>
            </div>
        `;

            // Ticket basic info section
            html += `
            <div class="ticket-section">
                <h3>Ticket Information</h3>
                <div class="ticket-info">
                    <div class="info-item">
                        <div class="info-label">Ticket Level</div>
                        <div class="info-value">
                            ${ticket.ticketlevel && ticket.ticketlevel.gmDescription ?
                    `<span class="level-badge level-${ticket.ticketlevel.gmDescription}">${ticket.ticketlevel.gmDescription}</span>` :
                    'N/A'}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Priority</div>
                        <div class="info-value">
                            ${ticket.priority && ticket.priority.gmDescription ?
                    `<span class="priority-badge priority-${ticket.priority.gmDescription}">${ticket.priority.gmDescription}</span>` :
                    'N/A'}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value">
                            ${ticket.status && ticket.status.gmDescription ?
                    `<span class="status-badge status-${ticket.status.gmDescription}">${ticket.status.gmDescription}</span>` :
                    'N/A'}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Client Name</div>
                        <div class="info-value">${ticket.clientid.clientName || 'N/A'}</div>
                    </div>
                 
                    <div class="info-item">
                        <div class="info-label">Created By</div>
                        <div class="info-value">${ticket.cmexpertId.cmeName || 'N/A'}</div>
                    </div>
               
                    <div class="info-item">
                        <div class="info-label">Created Date</div>
                        <div class="info-value">${ticket.createdon || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Business Entity</div>
                        <div class="info-value">${ticket.companyname || 'N/A'}</div>
                    </div>

                </div>
            </div>
        `;
            // Ticket description section
            html += `
                  <div class="ticket-section">
                      <h3>Issue Details</h3>
                      <div class="ticket-info">
                          <div class="info-item">
                              <div class="info-label">Issue Summary</div>
                              <div class="info-value">${ticket.ticketnote || 'N/A'}</div>
                          </div>
                         <br>
                          <div class="info-item">
                            <div class="info-label">Module</div>
                            <div class="info-value">${ticket.modulesid && ticket.modulesid.modcode ? ticket.modulesid.modcode : 'N/A'}</div>
                        </div>
                     
                         
                       
                    </div>
                    <br>
                    <br>

                <div>
                    <div class="attachment-item">
                        <div class="attachment-name" style="font-size: 18px; font-weight: bold;">Description</div>
                        <div class="describtion">${ticket.ticketdesc || 'N/A'}</div>
                        </div> 
                </div>
            </div>
               
                    <div class="ticket-section">
                 
                </div>
              `;
            // Attachments section
            if (ticket.attachments && ticket.attachments.length > 0) {
                html += `
                <div class="ticket-section">
                    <h3>Attachments</h3>
                    <div class="attachments-list">
            `;

                ticket.attachments.forEach(attachment => {
                    html += `
                    <div class="attachment-item">
                        <div class="attachment-name">${attachment.fileName || 'Unnamed File'}</div>
                        <div class="attachment-actions">
                            <button class="attachment-btn download-btn" onclick="downloadAttachment('${attachment.filePath}', '${attachment.fileName}')">Download</button>
                            <button class="attachment-btn view-file-btn" onclick="viewAttachment('${attachment.filePath}')">View</button>
                        </div>
                    </div>
                `;
                });

                html += `
                    </div>
                </div>
            `;
            }
            // Client details section
            if (ticket.clientid) {
                html += `
                <div class="ticket-section collapsible">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <span>Client Details</span>
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="collapsible-body">
                        <div class="ticket-info">
                        <div class="info-item">
                            <div class="info-label">Client Code</div>
                            <div class="info-value">${ticket.clientid.clientCode || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Client Name</div>
                            <div class="info-value">${ticket.clientid.clientName || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Client Group</div>
                            <div class="info-value">${ticket.clientid.clientGroup || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                </div>
                
            `;

                // SPOC details if available
                if (ticket.clientid.mclientSPOCMasters && ticket.clientid.mclientSPOCMasters.length > 0) {
                    const spoc = ticket.clientid.mclientSPOCMasters[0];
                    html += `

                    <div class="ticket-section collapsible">
                        <div class="collapsible-header" onclick="toggleSection(this)">
                            <span>SPOC Details</span>
                            <span class="toggle-icon">+</span>
                        </div>
                        <div class="collapsible-body">
                        <div class="ticket-info">
                            <div class="info-item">
                                <div class="info-label">SPOC Name</div>
                                <div class="info-value">${spoc.spocName || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Designation</div>
                                <div class="info-value">${spoc.designation || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email ID</div>
                                <div class="info-value">${spoc.emailId || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Contact Number</div>
                                <div class="info-value">${spoc.contactNumber || 'N/A'}</div>
                            </div>
                            </div>
                        </div>
                    </div>
                `;
                }
            }


            // CME details section
            if (ticket.cmexpertId) {
                html += `
                
                <div class="ticket-section collapsible">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <span>CME Details</span>
                        <span class="toggle-icon">+</span>
                    </div>

                    <div class="collapsible-body">
                    <div class="ticket-info">
                        <div class="info-item">
                            <div class="info-label">CME ID</div>
                            <div class="info-value">${ticket.cmexpertId.cmeId || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">CME Name</div>
                            <div class="info-value">${ticket.cmexpertId.cmeName || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Designation</div>
                            <div class="info-value">${ticket.cmexpertId.cmeDesignation || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Email ID</div>
                            <div class="info-value">${ticket.cmexpertId.cmeemailId || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Phone Number</div>
                            <div class="info-value">${ticket.cmexpertId.cmephoneNo || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                <div class="ticket-section">
                </div>

            `;
            }


            // Employee details section
            if (ticket.employeeId) {
                html += `
                <div class="ticket-section collapsible">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <span>Employee Details</span>
                        <span class="toggle-icon">+</span>
                    </div>
                    <div class="collapsible-body">
                        <div class="ticket-info">
                            <div class="info-item">
                                <div class="info-label">Employee Code</div>
                                <div class="info-value">${ticket.employeeId.empCode || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Employee Name</div>
                                <div class="info-value">${ticket.employeeId.empName || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email ID</div>
                                <div class="info-value">${ticket.employeeId.emailId || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Phone Number</div>
                                <div class="info-value">${ticket.employeeId.phoneNo || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ticket-section">
                    </div>
            `;
            } else {
                html += `
                <h3>Consultant Details</h3>
                <div class="ticket-info">
                    <div class="info-item">
                        <div class="info-value" style="color: #dc3545; font-weight: bold;">
                            This ticket is not assigned to any employee yet.
                        </div>
                    </div>
                </div>
          
        `;
            }



            modalContent.innerHTML = html;
            document.getElementById('ticketModal').style.display = 'block';
        }

        // Close the modal
        function closeModal() {
            document.getElementById('ticketModal').style.display = 'none';
        }

        // Format date time
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';

            try {
                const date = new Date(dateTimeStr);
                return date.toLocaleString();
            } catch (e) {
                return dateTimeStr;
            }
        }

        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function (event) {
            const modal = document.getElementById('ticketModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Function to download attachment with authentication
        async function downloadAttachment(filePath, fileName) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                // Show loading indicator
                showLoading(true);

                const response = await fetch(filePath, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error('Failed to download attachment');
                }

                // Get the blob from the response
                const blob = await response.blob();

                // Create a temporary URL for the blob
                const url = window.URL.createObjectURL(blob);

                // Create a temporary link element
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName || 'attachment';
                document.body.appendChild(a);

                // Trigger the download
                a.click();

                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading attachment:', error);
                alert('Failed to download attachment. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Function to view attachment with authentication
        // Function to view attachment with authentication
        async function viewAttachment(filePath) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                // Show loading indicator (optional)
                showLoading(true);

                const response = await fetch(filePath, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error('Failed to view attachment');
                }

                // Get the blob (binary content)
                const blob = await response.blob();

                // Create a temporary URL for the blob
                const blobUrl = window.URL.createObjectURL(blob);

                // Open the blob in a new tab
                window.open(blobUrl, '_blank');

                // Optionally revoke the blob URL later (after some delay)
                setTimeout(() => {
                    window.URL.revokeObjectURL(blobUrl);
                }, 1000 * 60); // 1 minute
            } catch (error) {
                console.error('Error viewing attachment:', error);
                alert('Failed to view attachment. Please try again.');
            } finally {
                showLoading(false);
            }
            
        }
          function toggleSection(headerElement) {
                const section = headerElement.parentElement;
                section.classList.toggle("active");
            }

    </script>

</body>

</html>
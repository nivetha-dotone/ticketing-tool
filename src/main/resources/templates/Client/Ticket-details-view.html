<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Ticket Details</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f4f4f4;
        }

        /* Header Styles */
        .header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #003366;
            color: white;
            padding: 24px 20px;
            position: fixed;
            top: 0;
            width: 99%;
            z-index: 100;
        }
        
        .header-left img {
            height: 50px;
            padding-left: 62%;
        }
        
        .header-center {
            flex: 1;
            padding-left: 57px;
            text-align: center;
        }
        
        .header-center h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 20px;
        }
        
        .profile-img {
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background-color: #0055aa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .profile-details {
            text-align: right;
        }
        
        .profile-name {
            margin: 0;
            font-size: 14px;
            font-weight: bold;
        }
        
        .admin-id {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 100px;
            width: 250px;
            height: calc(100% - 100px);
            background-color: #333;
            color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 90;
        }

        .sidebar.hidden {
            transform: translateX(-250px);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar ul li {
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .sidebar ul li a {
            text-decoration: none;
            color: white;
            display: block;
        }

        .sidebar ul li a:hover, .sidebar ul li.active a {
            background-color: #555;
        }

        /* Main Content */
        main {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
            margin-top: 100px;
            margin-bottom: 60px;
        }

        main.collapsed {
            margin-left: 0;
        }

        /* Kanban Board Styles */
        .kanban-container {
            display: flex;
            overflow-x: auto;
            padding-bottom: 20px;
            gap: 15px;
            min-height: calc(100vh - 250px);
        }

        .kanban-column {
            flex: 0 0 300px;
            background-color: #f0f0f0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .column-header {
            padding: 15px;
            background-color: #003366;
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .ticket-count {
            background-color: white;
            color: #003366;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .column-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Ticket Card Styles */
        .ticket-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #003366;
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .ticket-code {
            font-weight: bold;
            color: #003366;
        }

        .ticket-date {
            font-size: 12px;
            color: #666;
        }

        .ticket-badges {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        /* Level, Priority and Status Badges */
        .level-badge, .priority-badge, .status-badge {
            padding: 3px 8px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            display: inline-block;
            text-align: center;
        }

        /* Level Colors */
        .level-L1 {
            background-color: #28a745; /* Green */
        }

        .level-L2 {
            background-color: #ffc107; /* Yellow */
            color: black;
        }

        .level-L3 {
            background-color: #fd7e14; /* Orange */
        }

        .level-L4 {
            background-color: #dc3545; /* Red */
        }

        /* Priority Colors */
        .priority-P1 {
            background-color: #dc3545; /* Red - Highest */
        }

        .priority-P2 {
            background-color: #fd7e14; /* Orange - High */
        }

        .priority-P3 {
            background-color: #ffc107; /* Yellow - Medium */
            color: black;
        }

        .priority-P4 {
            background-color: #28a745; /* Green - Low */
        }

        /* Status Colors */
        .status-NEW {
            background-color: #007bff; /* Blue */
        }

        .status-IN-PROGRESS {
            background-color: #17a2b8; /* Cyan */
        }

        .status-ON-HOLD {
            background-color: #ffc107; /* Yellow */
            color: black;
        }

        .status-CANCEL {
            background-color: #6c757d; /* Gray */
        }

        .status-CLOSED {
            background-color: #343a40; /* Dark Gray */
        }

        .status-RESOLVED {
            background-color: #28a745; /* Green */
        }

        .status-PENDING {
            background-color: #dc3545; /* Red */
        }

        .ticket-info {
            margin-bottom: 10px;
        }

        .ticket-info-item {
            display: flex;
            margin-bottom: 5px;
        }

        .ticket-info-label {
            font-weight: bold;
            width: 80px;
            color: #666;
        }

        .ticket-info-value {
            flex: 1;
        }

        .ticket-description {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Modal/Popup Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            color: #858585;
            float: right;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }

        .close:hover {
            color: black;
        }

        /* Ticket Detail Styles */
        .ticket-detail-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ticket-detail-header h2 {
            margin: 0;
            color: #003366;
        }

        .ticket-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .ticket-section h3 {
            margin-top: 0;
            color: #003366;
            font-size: 18px;
        }

        .ticket-detail-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .info-item {
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
        }

        /* Attachment Styles */
        .attachments-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .attachment-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        .attachment-name {
            margin-bottom: 10px;
            word-break: break-all;
        }

        .attachment-actions {
            display: flex;
            gap: 10px;
        }

        .attachment-btn {
            flex: 1;
            padding: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }

        .download-btn {
            background-color: #28a745;
            color: white;
        }

        .view-file-btn {
            background-color: #007bff;
            color: white;
        }

        /* Status Update Section */
        .status-update-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .status-update-section h3 {
            margin-top: 0;
            color: #003366;
        }

        .status-update-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-update-form select, .status-update-form textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .status-update-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .update-status-btn {
            background-color: #003366;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-start;
        }

        /* Transaction History Styles */
        .transaction-history {
            margin-top: 20px;
        }

        .transaction-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .transaction-item.employee {
            border-left: 4px solid #007bff;
            background-color: #f0f7ff;
        }

        .transaction-item.client {
            border-left: 4px solid #dc3545;
            background-color: #fff8f8;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .transaction-id {
            color: #666;
        }

        .transaction-date {
            color: #666;
            font-size: 0.9em;
        }

        .transaction-user {
            margin-bottom: 10px;
        }

        .transaction-user-label {
            font-weight: bold;
            color: #555;
        }

        .transaction-comment {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .transaction-status {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Session expiry modal */
        .modal1 {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal1-content1 {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal1-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal1-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .primary1-button {
            background-color: #003366;
            color: white;
        }
        
        .primary1-button:hover {
            background-color: #004a8f;
        }
        
        .secondary1-button {
            background-color: #6c757d;
            color: white;
        }

        /* Loading Indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .loading:after {
            content: " ";
            display: block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 6px solid #003366;
            border-color: #003366 transparent #003366 transparent;
            animation: loading 1.2s linear infinite;
        }

        @keyframes loading {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* No Results Message */
        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* Footer Styles */
        .footer-main {
            background-color: #003366;
            color: white;
            text-align: center;
            padding: 10px 20px;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 90;
        }

        .toggle-btn {
            background-color: #003366;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            position: absolute;
            top: 29px;
            left: 10px;
            z-index: 1000;
        }

        /* Description box styling */
        .describtion {
            border: 1px solid #ccc;
            border-left: 5px solid #007bff;
            border-radius: 6px;
            background-color: #fefefe;
            color: #333;
            font-size: 16px;
            padding: 15px;
            line-height: 1.6;
            margin-top: 10px;
            white-space: pre-line;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Collapsible Section Styles */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            background-color: #e9f2ff;
            padding: 10px 15px;
            border: 1px solid #cce0ff;
            border-radius: 4px;
            color: #003366;
        }
        
        .toggle-icon {
            font-size: 20px;
            transition: transform 0.3s ease;
        }
        
        .collapsible-body {
            display: none;
            padding: 15px 10px 0;
        }
        
        .collapsible.active .collapsible-body {
            display: block;
        }
        
        .collapsible.active .toggle-icon {
            transform: rotate(45deg); /* turn "+" into "x" */
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header-main {
                padding: 15px 10px;
            }

            .header-left img {
                padding-left: 20%;
            }

            .header-center {
                padding-left: 20px;
            }

            main {
                margin-left: 0;
                padding: 10px;
            }

            .sidebar {
                transform: translateX(-250px);
            }

            .sidebar.visible {
                transform: translateX(0);
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .ticket-detail-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header-main">
        <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
        <div class="header-left">
            <img src="./DOT1 Logo.jpg" alt="Logo">
        </div>
        
        <div class="header-center">
            <h1>TRACK</h1>
        </div>
        <div class="header-right" id="profileSection">
            <!-- Profile content will be dynamically inserted here -->
        </div>
    </header>

    <div class="sidebar">
        <ul>
            <li ><a href="clientDashboard">Client Dashboard</a></li>
            <li class="active"><a href="clienttktALL" >My Tickets</a></li>
            <li ><a href="clientcreation">New Ticket</a></li>
            <li><a href="#">Notifications</a></li>
            <li><a href="Logout" onclick="logout()">Log Out</a></li>
        </ul>
    </div>

    <main>
        <h2>My Tickets</h2>
        
        <!-- Kanban Board Layout -->
        <div class="kanban-container">
            <div class="kanban-column" id="allTicketsColumn">
                <div class="column-header">
                    <h3>ALL</h3>
                    <span class="ticket-count" id="allCount">0</span>
                </div>
                <div class="column-content" id="allTickets">
                    <!-- Tickets will be loaded here -->
                    <div class="loading"></div>
                </div>
            </div>
            
            <div class="kanban-column" id="newTicketsColumn">
                <div class="column-header">
                    <h3>NEW</h3>
                    <span class="ticket-count" id="newCount">0</span>
                </div>
                <div class="column-content" id="newTickets">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
            
            <div class="kanban-column" id="inProgressTicketsColumn">
                <div class="column-header">
                    <h3>IN-PROGRESS</h3>
                    <span class="ticket-count" id="inProgressCount">0</span>
                </div>
                <div class="column-content" id="inProgressTickets">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
            
            <div class="kanban-column" id="onHoldTicketsColumn">
                <div class="column-header">
                    <h3>ON-HOLD</h3>
                    <span class="ticket-count" id="onHoldCount">0</span>
                </div>
                <div class="column-content" id="onHoldTickets">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
            
            <div class="kanban-column" id="resolvedTicketsColumn">
                <div class="column-header">
                    <h3>RESOLVED</h3>
                    <span class="ticket-count" id="resolvedCount">0</span>
                </div>
                <div class="column-content" id="resolvedTickets">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
            
            <div class="kanban-column" id="closedTicketsColumn">
                <div class="column-header">
                    <h3>CLOSED</h3>
                    <span class="ticket-count" id="closedCount">0</span>
                </div>
                <div class="column-content" id="closedTickets">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
            
            <div class="kanban-column" id="cancelTicketsColumn">
                <div class="column-header">
                    <h3>CANCEL</h3>
                    <span class="ticket-count" id="cancelCount">0</span>
                </div>
                <div class="column-content" id="cancelTickets">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
            
            <div class="kanban-column" id="pendingTicketsColumn">
                <div class="column-header">
                    <h3>PENDING</h3>
                    <span class="ticket-count" id="pendingCount">0</span>
                </div>
                <div class="column-content" id="pendingTickets">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Ticket Detail Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="ticketDetails">
                <!-- Ticket details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Session Expiry Modal -->
    <div id="sessionModal" class="modal1">
        <div class="modal1-content1">
            <h3>Session Expired</h3>
            <p>Your session has expired. Please login again to continue.</p>
            <div class="modal1-buttons">
                <button class="modal1-button primary1-button" onclick="redirectToLogin()">Login</button>
            </div>
        </div>
    </div>
    
    <footer class="footer-main">
        &copy; 2025 DOT 1. All Rights Reserved.
    </footer>

    <script>
        // Global variables
        let allTickets = [];
        let currentTicket = null;
        let statusOptions = [];
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadUserProfile();
            
            // Check token expiration immediately
            checkTokenExpiration();
            
            // Set up token expiration check every 30 seconds
            setInterval(checkTokenExpiration, 30000);
        });
        
        // Function to check if token is expired
        function isTokenExpired() {
            const tokenExpiry = localStorage.getItem('tokenExpiry');
            
            if (!tokenExpiry) {
                return true; // If there's no expiry time stored, assume expired
            }
        
            const expiryTime = Number(tokenExpiry); // Convert to number safely
            
            if (isNaN(expiryTime)) {
                console.warn("Invalid token expiry value in localStorage.");
                return true; // Treat invalid values as expired
            }
        
            return Date.now() > expiryTime;
        }
        
        // Function to check token expiration
        function checkTokenExpiration() {
            if (isTokenExpired()) {
                showSessionExpiredModal();
            }
        }
        
        // Function to show session expired modal
        function showSessionExpiredModal() {
            const modal = document.getElementById('sessionModal');
            modal.style.display = 'block';
            
            // Prevent closing the modal by clicking outside
            window.onclick = function(event) {
                if (event.target === modal) {
                    // Do nothing - force user to click the login button
                }
            };
        }
        
        // Function to redirect to login page
        function redirectToLogin() {
            logout();
            window.location.href = '../Login.html';
        }
        
        // Function to check authentication
        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token || isTokenExpired()) {
                redirectToLogin();
            }
        }
        
        // Function to load user profile
        function loadUserProfile() {
            try {
                const clientCMEDataStr = localStorage.getItem('clientCMEData');
                if (!clientCMEDataStr) {
                    console.error('No client data found in localStorage');
                    return;
                }
                
                const clientCMEData = JSON.parse(clientCMEDataStr);
                const profileSection = document.getElementById('profileSection');
                
                // Get first letter of client name for avatar
                const firstLetter = clientCMEData.cmeName ? clientCMEData.cmeName.charAt(0).toUpperCase() : 'U';
                
                profileSection.innerHTML = `
                    <div class="profile-img">${firstLetter}</div>
                    <div class="profile-details">
                        <p class="profile-name">${clientCMEData.cmeName || 'User'}</p>
                        <p class="admin-id">Client ID: ${clientCMEData.cmeId || 'N/A'}</p>
                    </div>
                `;
                
                // After loading profile, fetch tickets for this CME
                if (clientCMEData.cmeId) {
                    fetchTickets(clientCMEData.cmeId);
                } else {
                    console.error('No cmeId found in client data');
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }
        
        // Function to handle logout
        function logout() {
            // Clear all authentication data
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('tokenExpiry');
            localStorage.removeItem('userID');
            localStorage.removeItem('clientCMEData');
            
            // Redirect to login page
            window.location.href = '../Login.html';
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('main');
            sidebar.classList.toggle('hidden');
            main.classList.toggle('collapsed');
        }
        
        // Fetch tickets for a specific CME
        async function fetchTickets(cmeId) {
            showLoading(true);
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                console.log(`Fetching tickets for CME ID: ${cmeId}`);
                
                const response = await fetch(`http://103.115.194.81:8080/ticket/Client/getTicketByCMEID/${cmeId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error(`Failed to fetch tickets: ${response.status} ${response.statusText}`);
                }
                
                allTickets = await response.json();
                console.log(`Fetched ${allTickets.length} tickets`);
                
                // Organize tickets by status
                organizeTicketsByStatus(allTickets);
                
                // Fetch status options for later use
                fetchStatusOptions();
            } catch (error) {
                console.error('Error fetching tickets:', error);
                document.getElementById('allTickets').innerHTML = '<div class="no-results">Error loading tickets. Please try again later.</div>';
            } finally {
                showLoading(false);
            }
        }
        
        // Fetch status options for dropdown
        async function fetchStatusOptions() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch('http://103.115.194.81:8080/ticket/Client/dropofStatusClient', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error('Failed to fetch status options');
                }
                
                statusOptions = await response.json();
                console.log('Status options loaded:', statusOptions);
            } catch (error) {
                console.error('Error fetching status options:', error);
            }
        }
        
        // Organize tickets by status
        function organizeTicketsByStatus(tickets) {
            // Clear all columns
            document.getElementById('allTickets').innerHTML = '';
            document.getElementById('newTickets').innerHTML = '';
            document.getElementById('inProgressTickets').innerHTML = '';
            document.getElementById('onHoldTickets').innerHTML = '';
            document.getElementById('resolvedTickets').innerHTML = '';
            document.getElementById('closedTickets').innerHTML = '';
            document.getElementById('cancelTickets').innerHTML = '';
            document.getElementById('pendingTickets').innerHTML = '';
            
            // Reset counts
            let allCount = 0;
            let newCount = 0;
            let inProgressCount = 0;
            let onHoldCount = 0;
            let resolvedCount = 0;
            let closedCount = 0;
            let cancelCount = 0;
            let pendingCount = 0;
            
            if (tickets.length === 0) {
                document.getElementById('allTickets').innerHTML = '<div class="no-results">No tickets found.</div>';
                updateColumnCounts(0, 0, 0, 0, 0, 0, 0, 0);
                return;
            }
            
            // Generate HTML for each ticket
            tickets.forEach(ticket => {
                const ticketHtml = generateTicketCardHtml(ticket);
                
                // Add to ALL column
                document.getElementById('allTickets').innerHTML += ticketHtml;
                allCount++;
                
                // Add to specific status column
                if (ticket.status && ticket.status.gmDescription) {
                    switch (ticket.status.gmDescription) {
                        case 'NEW':
                            document.getElementById('newTickets').innerHTML += ticketHtml;
                            newCount++;
                            break;
                        case 'IN-PROGRESS':
                            document.getElementById('inProgressTickets').innerHTML += ticketHtml;
                            inProgressCount++;
                            break;
                        case 'ON-HOLD':
                            document.getElementById('onHoldTickets').innerHTML += ticketHtml;
                            onHoldCount++;
                            break;
                        case 'RESOLVED':
                            document.getElementById('resolvedTickets').innerHTML += ticketHtml;
                            resolvedCount++;
                            break;
                        case 'CLOSED':
                            document.getElementById('closedTickets').innerHTML += ticketHtml;
                            closedCount++;
                            break;
                        case 'CANCEL':
                            document.getElementById('cancelTickets').innerHTML += ticketHtml;
                            cancelCount++;
                            break;
                        case 'PENDING':
                            document.getElementById('pendingTickets').innerHTML += ticketHtml;
                            pendingCount++;
                            break;
                    }
                }
            });
            
            // Update column counts
            updateColumnCounts(allCount, newCount, inProgressCount, onHoldCount, resolvedCount, closedCount, cancelCount, pendingCount);
            
            // Show no results message for empty columns
            if (newCount === 0) document.getElementById('newTickets').innerHTML = '<div class="no-results">No tickets.</div>';
            if (inProgressCount === 0) document.getElementById('inProgressTickets').innerHTML = '<div class="no-results">No tickets.</div>';
            if (onHoldCount === 0) document.getElementById('onHoldTickets').innerHTML = '<div class="no-results">No tickets.</div>';
            if (resolvedCount === 0) document.getElementById('resolvedTickets').innerHTML = '<div class="no-results">No tickets.</div>';
            if (closedCount === 0) document.getElementById('closedTickets').innerHTML = '<div class="no-results">No tickets.</div>';
            if (cancelCount === 0) document.getElementById('cancelTickets').innerHTML = '<div class="no-results">No tickets.</div>';
            if (pendingCount === 0) document.getElementById('pendingTickets').innerHTML = '<div class="no-results">No tickets.</div>';
        }
        
        // Generate ticket card HTML
        function generateTicketCardHtml(ticket) {
            return `
                <div class="ticket-card" onclick="viewTicketDetails(${ticket.ticketid})">
                    <div class="ticket-header">
                        <div class="ticket-code">${ticket.ticketcode || 'N/A'}</div>
                        <div class="ticket-date">${formatDateTime(ticket.createdon) || 'N/A'}</div>
                    </div>
                    <div class="ticket-badges">
                        ${ticket.ticketlevel && ticket.ticketlevel.gmDescription ?
                        `<span class="level-badge level-${ticket.ticketlevel.gmDescription}">${ticket.ticketlevel.gmDescription}</span>` :
                        ''}

                        ${ticket.priority && ticket.priority.gmDescription ?
                        `<span class="priority-badge priority-${ticket.priority.gmDescription}">${ticket.priority.gmDescription}</span>` :
                        ''}
                    </div>
                    <div class="ticket-info">
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Module:</div>
                            <div class="ticket-info-value">${ticket.modulesid && ticket.modulesid.modcode ? ticket.modulesid.modcode : 'N/A'}</div>
                        </div>
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">Assign to:</div>
                            <div class="ticket-info-value">
                                ${ticket.employeeId ?
                                `${ticket.employeeId.empName || 'N/A'}` :
                                '<strong style="color: #dc3545;">Not assigned</strong>'}
                            </div>
                        </div>
                    </div>
                    <div class="ticket-description">${ticket.ticketnote || 'No description available'}</div>
                </div>
            `;
        }
        
        // Update column counts
        function updateColumnCounts(all, newCount, inProgress, onHold, resolved, closed, cancel, pending) {
            document.getElementById('allCount').textContent = all;
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('onHoldCount').textContent = onHold;
            document.getElementById('resolvedCount').textContent = resolved;
            document.getElementById('closedCount').textContent = closed;
            document.getElementById('cancelCount').textContent = cancel;
            document.getElementById('pendingCount').textContent = pending;
        }
        
        // View ticket details
        async function viewTicketDetails(ticketId) {
            showLoading(true);
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const response = await fetch(`http://103.115.194.81:8080/ticket/Client/getTicketWithAttachments/${ticketId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error('Failed to fetch ticket details');
                }
                
                const ticket = await response.json();
                currentTicket = ticket;
                
                // Fetch transaction history
                const transactionResponse = await fetch(`http://103.115.194.81:8080/ticket/Client/getTranscation/${ticketId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let transactions = [];
                if (transactionResponse.ok) {
                    transactions = await transactionResponse.json();
                } else {
                    console.error('Error fetching transaction history:', transactionResponse.status);
                }
                
                // Display ticket details with transactions
                displayTicketDetails(ticket, transactions);
                
                // Show the modal
                document.getElementById('ticketModal').style.display = 'block';
            } catch (error) {
                console.error('Error fetching ticket details:', error);
                alert('Failed to load ticket details. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        // Display ticket details in modal
        function displayTicketDetails(ticket, transactions) {
            const modalContent = document.getElementById('ticketDetails');
            
            // Ticket header with ticket code and type
            let html = `
                <div class="ticket-detail-header">
                    <h2>${ticket.ticketcode || 'N/A'}</h2>
                    <div>
                        ${ticket.tickettype && ticket.tickettype.gmDescription ? 
                        `<strong>${ticket.tickettype.gmDescription}</strong>` : ''}
                    </div>
                </div>
            `;
            
            // Ticket basic info section
            html += `
                <div class="ticket-section">
                    <h3>Ticket Information</h3>
                    <div class="ticket-detail-info">
                        <div class="info-item">
                            <div class="info-label">Ticket Level</div>
                            <div class="info-value">
                                ${ticket.ticketlevel && ticket.ticketlevel.gmDescription ?
                                `<span class="level-badge level-${ticket.ticketlevel.gmDescription}">${ticket.ticketlevel.gmDescription}</span>` :
                                'N/A'}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Priority</div>
                            <div class="info-value">
                                ${ticket.priority && ticket.priority.gmDescription ?
                                `<span class="priority-badge priority-${ticket.priority.gmDescription}">${ticket.priority.gmDescription}</span>` :
                                'N/A'}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Status</div>
                            <div class="info-value">
                                ${ticket.status && ticket.status.gmDescription ?
                                `<span class="status-badge status-${ticket.status.gmDescription}">${ticket.status.gmDescription}</span>` :
                                'N/A'}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Client Name</div>
                            <div class="info-value">${ticket.clientid?.clientName || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Created By</div>
                            <div class="info-value">${ticket.cmexpertId?.cmeName || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Created Date</div>
                            <div class="info-value">${formatDateTime(ticket.createdon) || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Business Entity</div>
                            <div class="info-value">${ticket.companyname || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ticket description section
            html += `
                <div class="ticket-section">
                    <h3>Issue Details</h3>
                    <div class="ticket-detail-info">
                        <div class="info-item">
                            <div class="info-label">Issue Summary</div>
                            <div class="info-value">${ticket.ticketnote || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Module</div>
                            <div class="info-value">${ticket.modulesid && ticket.modulesid.modcode ? ticket.modulesid.modcode : 'N/A'}</div>
                        </div>
                    </div>
                    <br>
                    <div>
                        <div class="attachment-item">
                            <div class="attachment-name" style="font-size: 18px; font-weight: bold;">Description</div>
                            <div class="describtion">${ticket.ticketdesc || 'N/A'}</div>
                        </div> 
                    </div>
                </div>
            `;
            
            // Attachments section
            if (ticket.attachments && ticket.attachments.length > 0) {
                html += `
                    <div class="ticket-section">
                        <h3>Attachments</h3>
                        <div class="attachments-list">
                `;
                
                ticket.attachments.forEach(attachment => {
                    html += `
                        <div class="attachment-item">
                            <div class="attachment-name">${attachment.fileName || 'Unnamed File'}</div>
                            <div class="attachment-actions">
                                <button class="attachment-btn download-btn" onclick="downloadAttachment('${attachment.filePath}', '${attachment.fileName}')">Download</button>
                                <button class="attachment-btn view-file-btn" onclick="viewAttachment('${attachment.filePath}')">View</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Employee details section
            if (ticket.employeeId) {
                html += `
                    <div class="ticket-section collapsible">
                        <div class="collapsible-header" onclick="toggleSection(this)">
                            <span>Consultant Details</span>
                            <span class="toggle-icon">+</span>
                        </div>
                        <div class="collapsible-body">
                            <div class="ticket-detail-info">
                                <div class="info-item">
                                    <div class="info-label">Employee Code</div>
                                    <div class="info-value">${ticket.employeeId.empCode || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Employee Name</div>
                                    <div class="info-value">${ticket.employeeId.empName || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Email ID</div>
                                    <div class="info-value">${ticket.employeeId.emailId || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Phone Number</div>
                                    <div class="info-value">${ticket.employeeId.phoneNo || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="ticket-section">
                        <h3>Consultant Details</h3>
                        <div class="ticket-detail-info">
                            <div class="info-item">
                                <div class="info-value" style="color: #dc3545; font-weight: bold;">
                                    This ticket is not assigned to any employee yet.
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Status update section
            html += `
                <div class="ticket-section">
                    <h3>Update Status</h3>
                    <div class="status-update-section">
                        <div class="status-update-form">
                            <select id="statusUpdateSelect">
                                <option value="">Select Status</option>
                                <!-- Status options will be loaded dynamically -->
                            </select>
                            <textarea id="statusCommentInput" placeholder="Enter comment (required)"></textarea>
                            <button class="update-status-btn" onclick="updateTicketStatus(${ticket.ticketid})">Update Status</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Transaction history section
            if (transactions && transactions.length > 0) {
                html += `
                    <div class="ticket-section">
                        <h3>Transaction History</h3>
                        <div class="transaction-history">
                `;
                
                transactions.forEach(transaction => {
                    const isEmployee = transaction.employeeDto && transaction.empNameDto;
                    const isClient = transaction.cmeexpertDto && transaction.cmeNameDto;
                    
                    html += `
                        <div class="transaction-item ${isEmployee ? 'employee' : isClient ? 'client' : ''}">
                            <div class="transaction-header">
                                <div class="transaction-id">Transaction ID: ${transaction.uaId || 'N/A'}</div>
                                <div class="transaction-date">${formatDateTime(transaction.updateDate) || 'N/A'}</div>
                            </div>
                            
                            <div class="transaction-user">
                                ${isEmployee ? 
                                `<div class="transaction-user-label">Consultant: ${transaction.empNameDto || 'N/A'} (${transaction.employeeDto || 'N/A'})</div>` : 
                                isClient ? 
                                `<div class="transaction-user-label">Client: ${transaction.cmeNameDto || 'N/A'} (${transaction.cmeexpertDto || 'N/A'})</div>` : ''}
                            </div>
                            
                            <div class="transaction-comment">
                                ${transaction.commentDto || 'No comment'}
                            </div>
                            
                            <div class="transaction-status">
                                <div>Status: ${transaction.statusName || 'N/A'}</div>
                                ${transaction.sub_statusDto ? `<div>Sub-Status: ${transaction.sub_statusDto.sub_status || 'N/A'}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = html;
            
            // Populate status dropdown based on current ticket status
            populateStatusDropdown(ticket.status?.gmDescription);
        }
        
        // Populate status dropdown based on current ticket status
        function populateStatusDropdown(currentStatus) {
            const statusSelect = document.getElementById('statusUpdateSelect');
            if (!statusSelect) return;
            
            statusSelect.innerHTML = '<option value="">Select Status</option>';
            
            if (currentStatus === 'RESOLVED') {
                // If current status is RESOLVED, only show CLOSED option
                const closedOption = statusOptions.find(status => status.gmDescription === 'CLOSED');
                if (closedOption) {
                    const option = document.createElement('option');
                    option.value = closedOption.gmid;
                    option.textContent = closedOption.gmDescription;
                    statusSelect.appendChild(option);
                }
            } else {
                // Otherwise show CANCEL and PENDING options
                const cancelOption = statusOptions.find(status => status.gmDescription === 'CANCEL');
                const pendingOption = statusOptions.find(status => status.gmDescription === 'PENDING');
                
                if (cancelOption) {
                    const option = document.createElement('option');
                    option.value = cancelOption.gmid;
                    option.textContent = cancelOption.gmDescription;
                    statusSelect.appendChild(option);
                }
                
                if (pendingOption) {
                    const option = document.createElement('option');
                    option.value = pendingOption.gmid;
                    option.textContent = pendingOption.gmDescription;
                    statusSelect.appendChild(option);
                }
            }
            
            // Log the available options for debugging
            console.log('Status options:', statusOptions);
            console.log('Current status:', currentStatus);
            console.log('Selected dropdown options:', statusSelect.innerHTML);
        }
        
        // Update ticket status
        async function updateTicketStatus(ticketId) {
            const statusSelect = document.getElementById('statusUpdateSelect');
            const statusId = statusSelect.value;
            const commentInput = document.getElementById('statusCommentInput');
            const comment = commentInput.value.trim();
            
            if (!statusId) {
                alert('Please select a status');
                return;
            }
            
            if (!comment) {
                alert('Please enter a comment');
                return;
            }
            
            // Confirm status update
            if (!confirm('Are you sure you want to update the ticket status?')) {
                return;
            }
            
            showLoading(true);
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                const clientCMEData = JSON.parse(localStorage.getItem('clientCMEData'));
                if (!clientCMEData || !clientCMEData.cmeId) {
                    throw new Error('Client data not found');
                }
                
                const gmid = clientCMEData.cmeId;
                console.log(`Updating ticket ${ticketId} with status ${statusId} by client ${gmid}`);
                
                // Update ticket status
                const statusResponse = await fetch(`http://103.115.194.81:8080/ticket/Client/ChangeStatusByClient/${ticketId}/${gmid}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!statusResponse.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error(`Failed to update ticket status: ${response.status} ${response.statusText}`);
                }
                
                // Add transaction record
                const transactionData = {
                    commentDto: comment,
                    cmeexpertDto: gmid,
                    statusDto: statusId,
                    ticket_numberDto: ticketId
                };
                
                console.log('Adding transaction with data:', transactionData);
                
                const transactionResponse = await fetch('http://103.115.194.81:8080/ticket/Client/addTranscation', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                });
                
                if (!transactionResponse.ok) {
                    console.error('Failed to add transaction record');
                }
                
                alert('Ticket status has been successfully updated.');
                
                // Refresh data
                closeModal();
                
                // Refresh tickets
                fetchTickets(clientCMEData.cmeId);
            } catch (error) {
                console.error('Error updating ticket status:', error);
                alert(`Failed to update ticket status: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // Function to download attachment with authentication
        async function downloadAttachment(filePath, fileName) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                // Show loading indicator
                showLoading(true);
                
                const response = await fetch(filePath, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error('Failed to download attachment');
                }
                
                // Get the blob from the response
                const blob = await response.blob();
                
                // Create a temporary URL for the blob
                const url = window.URL.createObjectURL(blob);
                
                // Create a temporary link element
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName || 'attachment';
                document.body.appendChild(a);
                
                // Trigger the download
                a.click();
                
                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading attachment:', error);
                alert('Failed to download attachment. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        // Function to view attachment with authentication
        async function viewAttachment(filePath) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }
                
                // Show loading indicator
                showLoading(true);
                
                const response = await fetch(filePath, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        checkTokenExpiration();
                    }
                    throw new Error('Failed to view attachment');
                }
                
                // Get the blob (binary content)
                const blob = await response.blob();
                
                // Create a temporary URL for the blob
                const blobUrl = window.URL.createObjectURL(blob);
                
                // Open the blob in a new tab
                window.open(blobUrl, '_blank');
                
                // Optionally revoke the blob URL later (after some delay)
                setTimeout(() => {
                    window.URL.revokeObjectURL(blobUrl);
                }, 1000 * 60); // 1 minute
            } catch (error) {
                console.error('Error viewing attachment:', error);
                alert('Failed to view attachment. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        // Format date time
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
        
            try {
                // Convert "15-04-2025 T 17:27:57" to "2025-04-15T17:27:57"
                const cleanedStr = dateTimeStr.replace(/\s*T\s*/, ' '); // Remove the "T" with optional spaces
                const [datePart, timePart] = cleanedStr.split(' ');
                const [day, month, year] = datePart.split('-');
        
                if (!day || !month || !year || !timePart) return 'N/A';
        
                const isoString = `${year}-${month}-${day}T${timePart}`;
                const date = new Date(isoString);
        
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
        
                // Extract parts manually
                const hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const hour12 = hours % 12 || 12; // Convert to 12-hour format
        
                // Pad minutes and hours
                const paddedHour = hour12.toString().padStart(2, '0');
                const paddedMinutes = minutes.toString().padStart(2, '0');
        
                return `${day}/${month}/${year}, ${paddedHour}:${paddedMinutes} ${ampm}`;
            } catch (e) {
                console.error('Error formatting date:', e);
                return 'N/A';
            }
        }
        
        // Toggle collapsible section
        function toggleSection(headerElement) {
            const section = headerElement.parentElement;
            section.classList.toggle("active");
        }
        
        // Close the modal
        function closeModal() {
            document.getElementById('ticketModal').style.display = 'none';
        }
        
        // Show/hide loading indicator
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('ticketModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
